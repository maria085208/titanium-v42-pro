<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GUIA DE ESTUDIO </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- EST√âTICA CL√çNICA PROFESIONAL --- */
        :root {
            --bg: #f1f5f9; --card: #ffffff; --border: #cbd5e1;
            --text: #0f172a; --dim: #64748b;
            --pri: #ef4444; --sec: #4f46e5; --acc: #10b981; --war: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 120px; 
            font-size: 15px; line-height: 1.6;
            overflow-wrap: break-word; word-wrap: break-word; hyphens: auto;
        }

        /* HEADER */
        header { 
            position: sticky; top: 0; z-index: 1000; 
            background: rgba(255,255,255,0.96); border-bottom: 1px solid var(--border); 
            padding: 10px 16px; backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .brand { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .brand span { color: var(--pri); background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px; }
        
        #clock { 
            background: #f8fafc; color: var(--dim); font-family: 'JetBrains Mono'; 
            text-align: center; font-size: 0.75rem; padding: 6px; border-radius: 6px; 
            border: 1px solid var(--border); font-weight: 700; text-transform: uppercase;
        }

        /* AUDIO */
        .ctrls { display: flex; gap: 6px; }
        .btn-mini { background: white; border: 1px solid var(--border); color: var(--dim); flex: 1; padding: 8px 0; border-radius: 6px; cursor: pointer; display: grid; place-items: center; transition: 0.2s; }
        .btn-mini:hover { border-color: var(--sec); color: var(--sec); background: #eef2ff; }
        .stop:hover { border-color: var(--pri); color: var(--pri); background: #fef2f2; }

        /* VISTAS */
        .view { display: none; padding: 16px; max-width: 900px; margin: 0 auto; animation: slide 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        .view.active { display: block; }
        @keyframes slide { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }

        /* TITULOS */
        .sec-head { margin-bottom: 20px; border-left: 5px solid var(--sec); padding-left: 15px; }
        .sec-head h2 { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .sec-head p { margin: 4px 0 0; color: var(--dim); font-size: 0.9rem; }

        /* CARDS & INPUTS */
        .card { 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px; 
            box-shadow: var(--shadow); 
        }
        .inp { 
            width: 100%; background: #f8fafc; border: 1px solid var(--border); 
            color: var(--text); padding: 14px; border-radius: 8px; font-size: 1rem; 
            margin-bottom: 10px; font-family: 'Inter'; transition: 0.2s;
        }
        .inp:focus { border-color: var(--sec); background: white; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }

        /* ESTUDIO */
        details { background: var(--card); margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        summary { padding: 18px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; background: white; align-items: center; }
        summary:hover { color: var(--sec); background: #f8fafc; }
        .txt { padding: 25px; color: #334155; line-height: 1.7; border-top: 1px solid var(--border); background: #fcfcfc; text-align: justify; }
        .txt h3 { color: var(--sec); margin-top: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; font-size: 1rem; }
        .hl { color: var(--pri); font-weight: bold; background: #fee2e2; padding: 0 4px; border-radius: 4px; }
        ul { padding-left: 20px; margin: 10px 0; } li { margin-bottom: 5px; }

        /* GRID T√ÅCTICO (2 COLUMNAS ROBUSTAS) */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }

        .item { 
            background: var(--card); border: 1px solid var(--border); padding: 15px; 
            border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; 
            justify-content: space-between; min-height: 110px; transition: 0.2s; 
            text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .item:hover { border-color: var(--sec); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .item h4 { margin: 0 0 5px 0; font-size: 0.9rem; font-weight: 700; color: var(--text); }
        .item span { font-size: 0.75rem; color: var(--dim); line-height: 1.25; }
        .icon { font-size: 1.5rem; margin-bottom: 8px; display: block; opacity: 0.8; }

        /* GRID FARMA (LISTA) */
        .g-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .row { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 10px; border-left: 5px solid var(--pri); }
        
        /* TAGS */
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .tg { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 700; border: 1px solid transparent; }
        .tg-t { background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; } 
        .tg-r { background: #fef2f2; color: #b91c1c; border-color: #fecaca; } 
        .tg-a { background: #ecfdf5; color: #047857; border-color: #a7f3d0; } 

        /* BOTONES */
        .btn { width: 100%; padding: 15px; background: #1e293b; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; margin-top: 15px; font-size: 0.95rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn.sec { background: var(--sec); } .btn.pri { background: var(--pri); }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.96); border-top: 1px solid var(--border); display: flex; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(10px); }
        .nav-b { flex: 1; padding: 10px 0; background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .nav-b.active { color: var(--sec); background: #f5f3ff; border-top: 3px solid var(--sec); margin-top: -3px; }
        .nav-b span { font-size: 1.4rem; } 
        .nav-b small { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }

        /* MODAL MEJORADO (PIZARR√ìN) */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); z-index: 5000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .box { background: #fff; width: 100%; max-width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; position: relative; }
        
        .f-disp { background: #0f172a; color: #10b981; font-family: 'JetBrains Mono', monospace; padding: 15px; border-radius: 8px; text-align: center; font-size: 1rem; margin-bottom: 20px; border: 1px solid #334155; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        
        .meta { background: #f8fafc; padding: 15px; border-radius: 8px; font-size: 0.9rem; color: #475569; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .meta strong { color: var(--text); display: block; margin-bottom: 4px; }
        
        #res { margin-top: 20px; padding: 15px; background: #ecfdf5; border: 1px solid #34d399; color: #047857; text-align: center; font-weight: 800; display: none; border-radius: 8px; font-size: 1.3rem; }
        
        .note { background: #fff; padding: 12px; border-left: 4px solid var(--sec); margin-bottom: 8px; font-size: 0.9rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<header>
    <div class="head">
        <div class="brand">GUIA DE ESTUDIO<span>CFMM</span></div>
        <div class="ctrls">
            <button class="btn-m" onclick="tts.p()">‚ñ∂</button>
            <button class="btn-m" onclick="tts.pa()">‚è∏</button>
            <button class="btn-m stop" onclick="tts.s()">‚èπ</button>
            <button class="btn-m" onclick="app.pdf()" style="font-weight:800;font-size:0.7rem">PDF</button>
        </div>
    </div>
    <div id="clock">CARGANDO...</div>
</header>

<div id="v-estudio" class="view active">
    <div class="sec-h"><h2>BIBLIOTECA</h2><p>ESTUDIAR PARA EXAMEN</p></div>
    <input type="text" class="inp" placeholder="üîç Buscar..." onkeyup="app.filter(this.value)">
    
    <div id="mod-list">
        <details>
            <summary>M√ìDULO 1: OPERACIONES Y SEGURIDAD</summary>
            <div class="txt">
                <h3>Ley del YO-YO ü™Ä</h3>
                <p>Regla fundamental de seguridad en la escena: <strong>1. Primero YO</strong> (Seguridad Personal), <strong>2. Luego YO</strong> (Seguridad de mi equipo), <strong>3. Al √∫ltimo YO</strong> (Seguridad del paciente). Nunca convertirse en una segunda v√≠ctima. Si la escena no es segura, NO ENTRAR y solicitar apoyo (polic√≠a, bomberos).</p>
                <h3>Evaluaci√≥n de Escena (Size-up)</h3>
                <p><strong>1. Seguridad (3S):</strong> Personal, Escena, Situaci√≥n.<br><strong>2. Cinem√°tica:</strong> Trauma (MOI) o Cl√≠nico (NOI).<br><strong>3. Triage:</strong> N√∫mero de pacientes y recursos.<br><strong>4. EPP:</strong> Aislamiento de sustancias corporales (Guantes, Gafas).</p>
                <h3>Aspectos Legales</h3>
                <p><strong>Negligencia:</strong> Deber de actuar, Incumplimiento, Da√±os, Causalidad.<br><strong>Consentimiento:</strong> Expreso (Verbal), Impl√≠cito (Inconsciente), Involuntario (Legal).</p>
            </div>
        </details>

        <details>
            <summary>M√ìDULO 2: EVALUACI√ìN PACIENTE</summary>
            <div class="txt">
                <h3>XABCDE (Prioridad Vital)</h3>
                <p><span class="hl">X:</span> Exanguinaci√≥n (Torniquete Alto y Apretado).<br><span class="hl">A:</span> V√≠a A√©rea + Control Cervical.<br><span class="hl">B:</span> Ventilaci√≥n (O2).<br><span class="hl">C:</span> Circulaci√≥n (Pulsos, Piel).<br><span class="hl">D:</span> D√©ficit Neuro (AVDI).<br><span class="hl">E:</span> Expo + Hipotermia.</p>
                <h3>Historial SAMPLE</h3>
                <p><strong>S:</strong> Signos/S√≠ntomas.<br><strong>A:</strong> Alergias.<br><strong>M:</strong> Medicamentos.<br><strong>P:</strong> Patolog√≠as previas.<br><strong>L:</strong> Lunch (√öltima comida).<br><strong>E:</strong> Eventos previos.</p>
                <h3>Dolor OPQRST</h3>
                <p><strong>O:</strong> Onset (Inicio).<br><strong>P:</strong> Provocaci√≥n.<br><strong>Q:</strong> Quality (Calidad).<br><strong>R:</strong> Radiaci√≥n.<br><strong>S:</strong> Severidad.<br><strong>T:</strong> Tiempo.</p>
            </div>
        </details>

        <details>
            <summary>M√ìDULO 3: V√çA A√âREA</summary>
            <div class="txt">
                <p><strong>OPA (Guedel):</strong> Solo inconscientes. Medir Comisura-√Ångulo.</p>
                <p><strong>NPA (Nasal):</strong> Conscientes. ‚õî Fx Base Cr√°neo.</p>
                <h3>Capnograf√≠a</h3>
                <p>Normal: 35-45 mmHg.<br>RCP <10: Mala calidad.<br>RCP >40: RCE (Retorno).</p>
            </div>
        </details>

        <details>
            <summary>M√ìDULO 4: CL√çNICO</summary>
            <div class="txt">
                <h3>SICA (Infarto)</h3>
                <p>MONA: Morfina, O2, Nitro (NO si TAS<90), Aspirina.</p>
                <h3>Diabetes</h3>
                <p><strong>Hipo (<60):</strong> S√∫bito, Fr√≠a. Tx: Glucosa.<br><strong>Cetoacidosis (>250):</strong> Lento, Seca, Kussmaul.</p>
            </div>
        </details>

        <details>
            <summary>M√ìDULO 5: TRAUMA</summary>
            <div class="txt">
                <h3>Triadas Letales</h3>
                <p><strong>Cushing (PIC):</strong> HTA + Bradi + Resp.Irreg.<br><strong>Beck (Taponade):</strong> Hipo + Yugular + Velados.</p>
            </div>
        </details>

        <details>
            <summary>M√ìDULO 6: POBLACIONES</summary>
            <div class="txt">
                <h3>Obstetricia</h3>
                <p><strong>Eclampsia:</strong> Convulsiones. Tx: Sulfato Mg. DLI.</p>
                <h3>Pediatr√≠a</h3>
                <p><strong>TEP:</strong> Apariencia, Respiraci√≥n, Circulaci√≥n. Bradicardia = Hipoxia.</p>
            </div>
        </details>
    </div>

    <div style="margin-top:20px; border-top:1px dashed #cbd5e1; padding-top:15px;">
        <h4 style="color:var(--sec);">NOTAS T√ÅCTICAS (NUBE)</h4>
        <textarea id="in-est" class="inp" rows="3" placeholder="Escribir apunte..."></textarea>
        <button class="btn sec" onclick="db.save('notas_estudio','in-est')">GUARDAR NOTA</button>
        <div id="out-est" style="margin-top:10px;"></div>
    </div>
</div>

<div id="v-lexico" class="view">
    <div class="sec-h"><h2>DICCIONARIO</h2><p>30 T√©rminos Clave</p></div>
    <input type="text" class="inp" placeholder="üîç Buscar..." onkeyup="app.renderLex(this.value)">
    <button class="btn" style="margin-bottom:15px; background:#fff; border:1px solid #e2e8f0; color:#0f172a;" onclick="app.tog('add-lex')">+ AGREGAR T√âRMINO</button>
    <div id="add-lex" class="card" style="display:none; border-left:4px solid var(--sec);">
        <input id="lx-c" class="inp" placeholder="Coloquial"><input id="lx-t" class="inp" placeholder="T√©cnico"><input id="lx-d" class="inp" placeholder="Descripci√≥n">
        <button class="btn sec" onclick="db.addLex()">GUARDAR</button>
    </div>
    <div id="lex-grid" class="g-list"></div>
</div>

<div id="v-farma" class="view">
    <div class="sec-h"><h2>VADEM√âCUM</h2><p>30 F√°rmacos | Dosis | Plan B</p></div>
    <input type="text" class="inp" placeholder="üîç Buscar f√°rmaco..." onkeyup="app.renderFarma(this.value)">
    <button class="btn" style="margin-bottom:15px; background:#fff; border:1px solid #ef4444; color:#ef4444;" onclick="app.tog('add-farma')">+ AGREGAR F√ÅRMACO</button>
    <div id="add-farma" class="card" style="display:none; border-left:4px solid var(--pri);">
        <input id="fm-n" class="inp" placeholder="Nombre"><input id="fm-u" class="inp" placeholder="Uso"><input id="fm-t" class="inp" placeholder="Paciente Ideal"><input id="fm-c" class="inp" placeholder="Contra"><input id="fm-a" class="inp" placeholder="Plan B"><input id="fm-d" class="inp" placeholder="Dosis">
        <button class="btn pri" onclick="db.addFarma()">GUARDAR</button>
    </div>
    <div id="farma-grid" class="g-list"></div>
</div>

<div id="v-signos" class="view">
    <div class="sec-h"><h2>MONITOR</h2><p>Registro Cl√≠nico</p></div>
    <div class="card">
        <div class="grid">
            <input type="number" id="sg-fc" class="inp" placeholder="FC (lpm)">
            <input type="number" id="sg-fr" class="inp" placeholder="FR (rpm)">
            <input type="number" id="sg-tas" class="inp" placeholder="TAS (mmHg)">
            <input type="number" id="sg-tad" class="inp" placeholder="TAD (mmHg)">
            <input type="number" id="sg-sp" class="inp" placeholder="SpO2 (%)">
            <input type="number" id="sg-te" class="inp" placeholder="Temp (¬∞C)">
            <input type="number" id="sg-gl" class="inp" placeholder="Glu (mg/dL)">
            <input type="text" id="sg-ox" class="inp" placeholder="Onda Oximetr√≠a">
        </div>
        <div style="margin-top:15px; border-top:1px dashed #cbd5e1; padding-top:15px;">
            <label style="color:var(--sec); font-weight:700;">CALCULADORA IMC</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="number" id="imc-m" class="inp" placeholder="Metros (1.70)"><input type="number" id="imc-k" class="inp" placeholder="Kilos (80)">
            </div>
            <button class="btn sec" style="margin-top:0;" onclick="app.calcIMC()">CALCULAR IMC</button>
            <div id="imc-res" style="text-align:center; font-weight:800; margin-top:10px; color:var(--text);"></div>
        </div>
        <button class="btn pri" onclick="db.saveVitals()">GUARDAR REGISTRO</button>
    </div>
    <div class="card">
        <h4 style="margin-top:0; color:var(--pri);">NOTAS CL√çNICAS</h4>
        <textarea id="in-sig" class="inp" rows="3"></textarea>
        <button class="btn pri" onclick="db.save('notas_signos','in-sig')">GUARDAR NOTA</button>
        <div id="out-sig" style="margin-top:10px;"></div>
    </div>
</div>

<div id="v-calc" class="view">
    <div class="sec-h"><h2>C√ÅLCULO</h2><p>30 Herramientas L√≥gicas</p></div>
    <div id="calc-grid" class="grid"></div>
</div>

<div id="v-sim" class="view">
    <div class="sec-h" style="display:flex; justify-content:space-between;">
        <div><h2>SIMULADOR</h2><p> (VEAMOS QUE TAL ESTAMOS...)</p></div>
        <div style="text-align:right;">RACHA<br><span id="sim-score" style="color:var(--acc); font-size:1.5rem; font-weight:900;">0</span></div>
    </div>
    <div class="card" style="text-align:center;">
        <h3 id="sim-q" style="font-size:1.1rem; margin-bottom:20px; line-height:1.4;">INICIANDO...</h3>
        <div id="sim-opts"></div>
        <div id="sim-fb" style="margin-top:20px; padding:15px; border-radius:8px; display:none; font-weight:bold;"></div>
        <button class="btn sec" style="margin-top:20px;" onclick="sim.next()">SIGUIENTE CASO</button>
    </div>
</div>

<nav>
    <button class="nav-b active" onclick="app.nav('estudio',this)"><span>üìñ</span><small>Est</small></button>
    <button class="nav-b" onclick="app.nav('lexico',this)"><span>üîç</span><small>Lex</small></button>
    <button class="nav-b" onclick="app.nav('farma',this)"><span>üíä</span><small>Far</small></button>
    <button class="nav-b" onclick="app.nav('signos',this)"><span>‚ù§Ô∏è</span><small>Sig</small></button>
    <button class="nav-b" onclick="app.nav('calc',this)"><span>üßÆ</span><small>Cal</small></button>
    <button class="nav-b" onclick="app.nav('sim',this)"><span>üéÆ</span><small>Sim</small></button>
</nav>

<div id="modal">
    <div class="box">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 id="md-ti" style="margin:0; color:var(--sec);">CALC</h3>
            <span style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('modal').style.display='none'">&times;</span>
        </div>
        <div id="md-form" class="f-disp"></div>
        <div class="meta">
            <div><strong>Procedimiento:</strong> <span id="md-proc"></span></div>
            <div style="margin-top:8px;"><strong>Valores Normales:</strong> <span id="md-check" style="color:var(--sec); font-weight:700;"></span></div>
        </div>
        <div id="md-in"></div>
        <button class="btn sec" style="margin-top:20px;" onclick="app.runC()">CALCULAR</button>
        <div id="res"></div>
    </div>
</div>

<script>
// --- DATOS DUROS 100% REALES (30 CALCULADORAS) ---
const TOOLS = {
    "Glasgow": {d:"Conciencia", fo:"Ocular + Verbal + Motora", p:"Sume las respuestas.", c:"3-15. <=8 Intubar.", i:[{l:"Ocular (1-4)",id:"g1"},{l:"Verbal (1-5)",id:"g2"},{l:"Motor (1-6)",id:"g3"}], f:v=>+v[0]+ +v[1]+ +v[2], r:v=>v<=8?"TCE GRAVE (INTUBAR)":v<=12?"MODERADO":"LEVE"},
    "Parkland": {d:"Liq Quemados", fo:"4ml √ó Kg √ó %SCQ", p:"Calcula l√≠quidos 24h.", c:"50% en 1ras 8h.", i:[{l:"Peso kg",id:"p1"},{l:"SCQ %",id:"p2"}], f:v=>4*v[0]*v[1], r:v=>`24h: ${v} ml (8h: ${v/2} ml)`},
    "PAM": {d:"Presi√≥n Media", fo:"(TAS + 2¬∑TAD) / 3", p:"Presi√≥n de perfusi√≥n.", c:"Normal: 70-105 mmHg.", i:[{l:"TAS",id:"m1"},{l:"TAD",id:"m2"}], f:v=>(+v[0]+2*+v[1])/3, r:v=>`PAM: ${v.toFixed(1)} mmHg`},
    "Shock Index": {d:"Riesgo Shock", fo:"FC / TAS", p:"√çndice de Shock.", c:">0.9 indica shock oculto.", i:[{l:"FC",id:"s1"},{l:"TAS",id:"s2"}], f:v=>v[0]/v[1], r:v=>v>0.9?"ALTO RIESGO SHOCK":"Estable"},
    "APGAR": {d:"Vitalidad RN", fo:"A+P+G+A+R", p:"Suma de 5 signos (0-2).", c:">=7 Normal. <4 Severo.", i:[{l:"Suma Puntos",id:"a1"}], f:v=>v[0], r:v=>v>=7?"Normal":"Depresi√≥n"},
    "Silverman": {d:"Dif. Resp RN", fo:"Suma de Signos", p:"Eval√∫a dificultad.", c:"0=Normal. >3 Dificultad.", i:[{l:"Suma Puntos",id:"v1"}], f:v=>v[0], r:v=>v==0?"Normal":"Dificultad"},
    "Naegele": {d:"FPP", fo:"FUM + 7d - 3m + 1a", p:"Fecha Probable Parto.", c:"Margen +/- 2 semanas.", i:[{l:"FUM",id:"n1",t:"date"}], f:v=>{let d=new Date(v[0]);d.setDate(d.getDate()+280);return d.toLocaleDateString()}, r:v=>`FPP: ${v}`},
    "Dosis Ped": {d:"Farma Ped", fo:"Peso √ó Dosis", p:"C√°lculo de medicamento.", c:"Verificar dosis max.", i:[{l:"Peso Kg",id:"d1"},{l:"mg/kg",id:"d2"}], f:v=>v[0]*v[1], r:v=>`Dosis Total: ${v} mg`},
    "Goteo IV": {d:"Vel. Infusi√≥n", fo:"(Vol √ó Gts) / Min", p:"Velocidad de infusi√≥n.", c:"Normo=20, Micro=60.", i:[{l:"Volumen ml",id:"o1"},{l:"Horas",id:"o2"},{l:"Factor Gto",id:"o3"}], f:v=>(v[0]*v[2])/(v[1]*60), r:v=>`${Math.round(v)} gts/min`},
    "IMC": {d:"Masa Corp", fo:"Peso / Talla¬≤", p:"√çndice Masa Corporal.", c:"18.5-24.9 Normal.", i:[{l:"Peso Kg",id:"i1"},{l:"Talla m",id:"i2"}], f:v=>v[0]/(v[1]*v[1]), r:v=>`IMC: ${v.toFixed(1)}`},
    "qSOFA": {d:"Sepsis Rap", fo:"GCS + TAS + FR", p:"Criterios r√°pidos.", c:">=2 Alto Riesgo.", i:[{l:"GCS<15 (1)",id:"q1"},{l:"TAS<100",id:"q2"},{l:"FR>22",id:"q3"}], f:v=>+v[0]+ +v[1]+ +v[2], r:v=>v>=2?"ALTO RIESGO SEPSIS":"Bajo Riesgo"},
    "Trauma RTS": {d:"Score Trauma", fo:"GCS + TAS + FR", p:"Revised Trauma Score.", c:"Bajo = Mortalidad Alta.", i:[{l:"GCS Code",id:"r1"},{l:"TAS Code",id:"r2"},{l:"FR Code",id:"r3"}], f:v=>+v[0]+ +v[1]+ +v[2], r:v=>`Score: ${v}`},
    "Anion Gap": {d:"Acidosis", fo:"Na - (Cl + HCO3)", p:"Brecha Ani√≥nica.", c:"Normal: 8-12 mEq/L.", i:[{l:"Na",id:"ag1"},{l:"Cl",id:"ag2"},{l:"HCO3",id:"ag3"}], f:v=>v[0]-(+v[1]+ +v[2]), r:v=>`Gap: ${v}`},
    "QT Corr": {d:"Cardio QT", fo:"QT / ‚àöRR", p:"F√≥rmula de Bazett.", c:"Normal <440ms.", i:[{l:"QT ms",id:"qt1"},{l:"FC",id:"qt2"}], f:v=>v[0]/Math.sqrt(60/v[1]), r:v=>`QTc: ${Math.round(v)} ms`},
    "Na Corr": {d:"Gluco Na", fo:"Na + 1.6√ó((Glu-100)/100)", p:"Sodio corregido.", c:"En hiperglucemia.", i:[{l:"Na medido",id:"nc1"},{l:"Glucosa",id:"nc2"}], f:v=>+v[0]+1.6*((v[1]-100)/100), r:v=>`Na Real: ${v.toFixed(1)}`},
    "Def H2O": {d:"HiperNa", fo:"0.6 √ó Kg √ó ((Na/140)-1)", p:"D√©ficit de agua libre.", c:"Litros a reponer.", i:[{l:"Peso Kg",id:"dh1"},{l:"Na Actual",id:"dh2"}], f:v=>0.6*v[0]*((v[1]/140)-1), r:v=>`Faltan: ${v.toFixed(1)} L`},
    "Cockcroft": {d:"Renal TFG", fo:"((140-Ed)√óKg) / (72√óCr)", p:"Depuraci√≥n Creatinina.", c:"Mujer x 0.85.", i:[{l:"Edad",id:"ck1"},{l:"Kg",id:"ck2"},{l:"Cr",id:"ck3"}], f:v=>((140-v[0])*v[1])/(72*v[2]), r:v=>`TFG: ${v.toFixed(1)} ml/min`},
    "Holliday": {d:"Liq Ped", fo:"10kg(4)+10kg(2)+Rest(1)", p:"Mantenimiento horario.", c:"ml/hora.", i:[{l:"Peso Kg",id:"hl1"}], f:v=>v[0]<=10?v[0]*4:v[0]<=20?40+(v[0]-10)*2:60+(v[0]-20), r:v=>`${v} ml/h`},
    "Tanque O2": {d:"Tiempo O2", fo:"(PSI-200)√ó0.28 / LPM", p:"Duraci√≥n Tanque E.", c:"Minutos restantes.", i:[{l:"PSI",id:"ox1"},{l:"LPM",id:"ox2"}], f:v=>((v[0]-200)*0.28)/v[1], r:v=>`${Math.round(v)} min`},
    "FC Meta": {d:"Esfuerzo", fo:"220 - Edad", p:"Frecuencia M√°xima.", c:"Te√≥rica.", i:[{l:"Edad",id:"fc1"}], f:v=>220-v[0], r:v=>`Max: ${v} lpm`},
    "Peso Ideal": {d:"Ventilaci√≥n", fo:"50 + 2.3 √ó (Pulg-60)", p:"Peso Predicho ARDS.", c:"6-8ml/kg VT.", i:[{l:"Altura Pulg",id:"pi1"}], f:v=>50+2.3*(v[0]-60), r:v=>`${v.toFixed(1)} kg`},
    "Sup Corp": {d:"Dosis SC", fo:"‚àö((cm √ó kg) / 3600)", p:"Superficie Corporal.", c:"Metros cuadrados.", i:[{l:"cm",id:"bs1"},{l:"kg",id:"bs2"}], f:v=>Math.sqrt((v[0]*v[1])/3600), r:v=>`${v.toFixed(2)} m¬≤`},
    "Centor": {d:"Faringitis", fo:"Suma Criterios", p:"Prob. Bacteriana.", c:">=3 Antibi√≥tico.", i:[{l:"Puntos 0-4",id:"cn1"}], f:v=>v[0], r:v=>v>=3?"Antibi√≥tico":"Viral"},
    "Wells": {d:"TVP", fo:"Suma Criterios", p:"Riesgo Trombosis.", c:">=2 Probable.", i:[{l:"Puntos",id:"wl1"}], f:v=>v[0], r:v=>v>=2?"Probable":"Bajo"},
    "PERC": {d:"TEP Descarte", fo:"Criterios Descarte", p:"Exclusi√≥n TEP.", c:"0 = Descartado.", i:[{l:"Positivos",id:"pr1"}], f:v=>v[0], r:v=>v==0?"Descartado":"Posible"},
    "NEXUS": {d:"Cervical", fo:"Criterios", p:"Regla Canadiense.", c:"0 = Retirar Collar√≠n.", i:[{l:"Positivos",id:"nx1"}], f:v=>v[0], r:v=>v==0?"Retirar Collar":"Imagen"},
    "Canadian": {d:"C-Spine", fo:"Factores Riesgo", p:"Necesidad Rx.", c:"1 = Radiograf√≠a.", i:[{l:"Riesgo (1=Si)",id:"cc1"}], f:v=>v[0], r:v=>v==1?"Radiograf√≠a":"Evaluar"},
    "Alvarado": {d:"Ap√©ndice", fo:"MANTRELS", p:"Diagn√≥stico.", c:">=7 Cirug√≠a.", i:[{l:"Score",id:"al1"}], f:v=>v[0], r:v=>v>=7?"Cirug√≠a":"Observar"},
    "Regla 9s": {d:"SCQ", fo:"Suma √Åreas", p:"Superficie Quemada.", c:"Adulto.", i:[{l:"% Suma",id:"r91"}], f:v=>v[0], r:v=>`Total: ${v}%`},
    "Cincinnati": {d:"EVC", fo:"Cara + Brazo + Habla", p:"Escala Prehospitalaria.", c:"1 signo = 72%.", i:[{l:"Positivos",id:"ci1"}], f:v=>v[0], r:v=>v>0?"PROBABLE":"Normal"}
};

// --- BASE DE DATOS: 30 F√ÅRMACOS (ETIQUETADOS) ---
const FARMA = [
    {n:"Aspirina", i:"IAM (Antiagregante)", p:"Adulto Dolor Tor√°cico", c:"√ölcera activa, Alergia", a:"Clopidogrel", d:"160-325mg Masticada"},
    {n:"Nitroglicerina", i:"Angina / EAP", p:"HTA + Dolor Precordial", c:"TAS<90, Viagra (24h)", a:"Morfina (Dolor)", d:"0.4mg SL cada 5min"},
    {n:"Epinefrina 1:1000", i:"Anafilaxia / Asma", p:"Shock Al√©rgico", c:"HTA Relativa", a:"Difenhidramina", d:"0.3 - 0.5mg IM"},
    {n:"Epinefrina 1:10000", i:"Paro Cardiaco", p:"Sin pulso (FV/TV/Asist)", c:"Ninguna", a:"Vasopresina", d:"1mg IV cada 3-5min"},
    {n:"Salbutamol", i:"Broncoespasmo", p:"Asma, EPOC", c:"Taquicardia >140", a:"Ipratropio", d:"2.5mg Nebulizado"},
    {n:"Naloxona", i:"Opioides", p:"Sobredosis + Depresi√≥n", c:"Ninguna en paro", a:"Ventilaci√≥n BVM", d:"0.4 - 2mg IN/IV"},
    {n:"Glucosa Oral", i:"Hipoglucemia", p:"Diab√©tico Consciente", c:"Inconsciente (Broncoasp)", a:"Glucag√≥n / Dextrosa", d:"15 - 20g Oral"},
    {n:"Carb√≥n Activado", i:"Intoxicaci√≥n", p:"Ingesta <1h", c:"C√°usticos, Coma", a:"Lavado G√°strico", d:"1g/kg Oral"},
    {n:"Atropina", i:"Bradicardia", p:"Sintom√°tico Inestable", c:"Glaucoma", a:"Marcapasos", d:"0.5 - 1mg IV"},
    {n:"Amiodarona", i:"FV / TV", p:"Paro Refractario", c:"Bloqueo AV", a:"Lidoca√≠na", d:"300mg IV (1ra dosis)"},
    {n:"Lidoca√≠na", i:"Alt. FV/TV", p:"Alergia Amiodarona", c:"Alergia Amidas", a:"Amiodarona", d:"1 - 1.5mg/kg IV"},
    {n:"Adenosina", i:"TPSV", p:"Taqui Supra Est", c:"Asma (Broncoconstricci√≥n)", a:"Verapamilo", d:"6mg R√°pido IV"},
    {n:"Ondansetr√≥n", i:"V√≥mito", p:"N√°usea Severa", c:"QT Largo", a:"Metoclopramida", d:"4mg IV/Oral"},
    {n:"Ketorolaco", i:"Dolor", p:"C√≥lico Renal", c:"Sangrado, Renal, Emb", a:"Paracetamol", d:"30mg IV / 60mg IM"},
    {n:"Diazepam", i:"Convulsi√≥n", p:"Crisis Activa", c:"Hipotensi√≥n", a:"Midazolam", d:"5 - 10mg IV"},
    {n:"Morfina", i:"Dolor IAM", p:"Dolor Severo", c:"Hipotensi√≥n, TCE", a:"Fentanilo", d:"2 - 4mg IV"},
    {n:"Furosemida", i:"EAP", p:"ICC + HTA", c:"Hipotensi√≥n", a:"Nitroglicerina", d:"40mg IV"},
    {n:"Hidrocortisona", i:"Alergia / EPOC", p:"Inflamaci√≥n", c:"Micosis", a:"Dexametasona", d:"100 - 500mg IV"},
    {n:"Difenhidramina", i:"Alergia", p:"Leve / Moderada", c:"Asma Agudo", a:"Loratadina", d:"25 - 50mg IV/IM"},
    {n:"Glucag√≥n", i:"Hipoglucemia", p:"Sin v√≠a IV", c:"Feocromocitoma", a:"Dextrosa IV", d:"1mg IM"},
    {n:"Midazolam", i:"Sedaci√≥n", p:"Convulsi√≥n / Cardioversi√≥n", c:"Shock", a:"Diazepam", d:"2 - 5mg IV"},
    {n:"Ipratropio", i:"EPOC / Asma", p:"Broncoespasmo", c:"Alergia Soya", a:"Salbutamol", d:"500mcg Nebulizado"},
    {n:"Fentanilo", i:"Trauma", p:"Inestable", c:"Depresi√≥n Resp", a:"Morfina", d:"50 - 100mcg IV"},
    {n:"Sulfato Mg", i:"Eclampsia", p:"Embarazada Conv.", c:"Bloqueo Cardiaco", a:"Benzos", d:"4g IV Lento"},
    {n:"Gluconato Ca", i:"Hiperkalemia", p:"Renal / Picadura", c:"Digitalicos", a:"Cloruro Ca", d:"1g IV"},
    {n:"Bicarbonato", i:"Acidosis", p:"Paro prolongado", c:"Alcalosis", a:"Hiperventilaci√≥n", d:"1mEq/kg IV"},
    {n:"Dopamina", i:"Bradicardia", p:"Shock", c:"Taquiarritmia", a:"Adrenalina", d:"5 - 20mcg/kg/min"},
    {n:"Norepinefrina", i:"Sepsis", p:"Hipotenso", c:"Hipovolemia", a:"Dopamina", d:"0.1 - 0.5mcg/kg/min"},
    {n:"Ac. Tranex√°mico", i:"Hemorragia", p:"Trauma <3h", c:">3h lesi√≥n", a:"Presi√≥n Directa", d:"1g IV en 10 min"},
    {n:"Paracetamol IV", i:"Fiebre / Dolor", p:"Todos", c:"Falla Hep√°tica", a:"Metamizol", d:"1g IV"}
];

// --- 3. L√âXICO (30 T√âRMINOS) ---
const LEXICO = [
    {t:"S√≠ncope", c:"Desmayo", d:"P√©rdida transitoria de conciencia por hipoperfusi√≥n cerebral."},
    {t:"Epistaxis", c:"Sangre Nariz", d:"Hemorragia de la mucosa nasal (Anterior/Posterior)."},
    {t:"Diaforesis", c:"Sudar Fr√≠o", d:"Sudoraci√≥n profusa patol√≥gica."},
    {t:"Cianosis", c:"Morado", d:"Coloraci√≥n azulada de piel por falta de ox√≠geno."},
    {t:"Disnea", c:"Falta Aire", d:"Dificultad respiratoria o sed de aire."},
    {t:"Hematemesis", c:"V√≥mito Sangre", d:"V√≥mito con sangre (Origen g√°strico)."},
    {t:"Hemoptisis", c:"Tos Sangre", d:"Expectoraci√≥n con sangre (Origen pulmonar)."},
    {t:"Melena", c:"Pop√≥ Negra", d:"Heces oscuras por sangre digerida (Hemorragia alta)."},
    {t:"Anisocoria", c:"Pupilas Raras", d:"Asimetr√≠a del tama√±o de las pupilas."},
    {t:"Urticaria", c:"Ronchas", d:"Lesiones d√©rmicas rojas y pruriginosas (Alergia)."},
    {t:"Equimosis", c:"Moret√≥n", d:"Sangrado subcut√°neo (Morado)."},
    {t:"Abrasi√≥n", c:"Rasp√≥n", d:"Lesi√≥n superficial de la piel por fricci√≥n."},
    {t:"Laceraci√≥n", c:"Cortada", d:"Herida por desgarro de tejido."},
    {t:"Sibilancias", c:"Pito Pecho", d:"Sonido agudo al respirar (Broncoespasmo)."},
    {t:"Estertores", c:"Burbujeo", d:"Sonido de l√≠quido en alv√©olos (EAP)."},
    {t:"Edema", c:"Hinchaz√≥n", d:"Acumulaci√≥n de l√≠quido en tejidos."},
    {t:"Ictericia", c:"Amarillo", d:"Piel amarilla por bilirrubina alta."},
    {t:"Artralgia", c:"Dolor Articulaci√≥n", d:"Dolor en las articulaciones."},
    {t:"Priapismo", c:"Erecci√≥n", d:"Erecci√≥n dolorosa involuntaria (Trauma medular)."},
    {t:"Hematoquecia", c:"Sangre Rectal", d:"Sangre roja brillante por recto."},
    {t:"Rinorrea", c:"Moco", d:"Secreci√≥n nasal excesiva."},
    {t:"Otorrea", c:"L√≠quido O√≠do", d:"Salida de flujo por el conducto auditivo."},
    {t:"Otorragia", c:"Sangre O√≠do", d:"Sangrado por el o√≠do (Trauma)."},
    {t:"Livedo Reticularis", c:"Piel Moteada", d:"Piel con patr√≥n de red (Mala perfusi√≥n)."},
    {t:"Ojos de Mapache", c:"Ojos Negros", d:"Equimosis periorbitaria (Fx Base Cr√°neo)."},
    {t:"Enfisema Subcut√°neo", c:"Aire en Piel", d:"Aire bajo la piel (Crepitaci√≥n)."},
    {t:"Apnea", c:"Sin Respirar", d:"Cese de la respiraci√≥n."},
    {t:"Taquipnea", c:"Resp R√°pida", d:"Frecuencia respiratoria > 20 rpm."},
    {t:"Taquicardia", c:"Pulso R√°pido", d:"Frecuencia cardiaca > 100 lpm."},
    {t:"Bradicardia", c:"Pulso Lento", d:"Frecuencia cardiaca < 60 lpm."}
];

// --- 4. SIMULADOR (100 CASOS) ---
const CASES = [
    {q:"Masc 25a, Accidente Moto. Sangrado arterial muslo derecho. P√°lido, diafor√©tico. ¬øPrioridad?", o:["A. V√≠a A√©rea","B. Torniquete","C. 2 V√≠as IV","D. Collar√≠n"], a:1, e:"En XABCDE, la hemorragia exanguinante (X) se trata antes que A."},
    {q:"Fem 60a, Dolor opresivo retroesternal, TAS 80/50. ¬øF√°rmaco CONTRAINDICADO?", o:["A. Aspirina","B. Ox√≠geno","C. Nitroglicerina","D. Clopidogrel"], a:2, e:"Nitroglicerina est√° contraindicada si TAS < 90 mmHg."},
    {q:"Pedi√°trico 4a, Estridor, Babeo, Posici√≥n Tr√≠pode. ¬øAcci√≥n?", o:["A. Abatelenguas","B. O2 a tolerancia y traslado","C. Intubaci√≥n inmediata","D. Nebulizar"], a:1, e:"Sospecha de Epiglotitis. NO manipular v√≠a a√©rea, riesgo de cierre total."},
    {q:"Masc 70a, Inicio s√∫bito debilidad hemicuerpo derecho y afasia. Tiempo 2hrs.", o:["A. Aspirina","B. Traslado r√°pido a TAC","C. Control glucosa","D. B y C"], a:3, e:"Activar c√≥digo Ictus. Ventana trombol√≠tica activa. Descartar hipoglucemia."},
    {q:"Quemadura Facial y vibrisas chamuscadas. Voz ronca.", o:["A. Intubaci√≥n Temprana","B. Salbutamol","C. Corticoides","D. V√≠a IV"], a:0, e:"Signos de quemadura de v√≠a a√©rea. Intubar antes de que el edema cierre la glotis."},
    {q:"Emb 34 SDG, Cefalea intensa, TA 160/110, Convulsiones t√≥nico-cl√≥nicas.", o:["A. Diazepam","B. Fenito√≠na","C. Sulfato de Magnesio","D. Labetalol"], a:2, e:"Eclampsia. El tratamiento de elecci√≥n es Sulfato de Magnesio."},
    {q:"Trauma T√≥rax. Ingurgitaci√≥n Yugular, Ruidos Velados, Hipotensi√≥n.", o:["A. Neumot√≥rax Tensi√≥n","B. Taponade Cardiaco","C. Hemot√≥rax","D. Contusi√≥n"], a:1, e:"Triada de Beck = Taponade Cardiaco."},
    {q:"Masc 30a, Herida arma blanca t√≥rax. Disnea severa, ausencia ruidos lado derecho, desviaci√≥n traqueal.", o:["A. O2 Mascarilla","B. Descompresi√≥n Aguja","C. Sello 3 lados","D. Intubaci√≥n"], a:1, e:"Neumot√≥rax a Tensi√≥n. Descompresi√≥n inmediata 2do/5to EIC."},
    {q:"Fem 20a, Intoxicaci√≥n por √≥rganofosforados. Sialorrea, Miosis.", o:["A. Adrenalina","B. Atropina","C. Flumazenil","D. Naloxona"], a:1, e:"Atropina a dosis respuesta para secar secreciones."},
    {q:"Neonato, FC 50 lpm a pesar de ventilaci√≥n efectiva 30 seg.", o:["A. Seguir ventilando","B. Compresiones","C. Adrenalina","D. Calentar"], a:1, e:"En neonatos, FC < 60 lpm indica iniciar compresiones."},
    {q:"Masc 45a, DM2. Inconsciente, Piel fr√≠a y h√∫meda.", o:["A. Insulina","B. Glucag√≥n/Glucosa","C. Soluci√≥n Salina","D. Metformina"], a:1, e:"Cl√≠nica de Hipoglucemia. Requiere glucosa r√°pida."},
    {q:"Masc 22a, Trauma Medular. Piel caliente, seca, rosada. TA 70/40, FC 54.", o:["A. Shock Hipovol√©mico","B. Shock Neurog√©nico","C. Shock S√©ptico","D. Shock Cardiog√©nico"], a:1, e:"Shock Neurog√©nico: P√©rdida tono simp√°tico (Hipotensi√≥n + Bradicardia + Piel caliente)."},
    {q:"Fem 55a, EPOC. Disnea. SpO2 88%. ¬øManejo O2?", o:["A. 15L Reservorio","B. Puntas 2L (Meta 88-92%)","C. No dar O2","D. Ventilaci√≥n Positiva"], a:1, e:"En EPOC retenedor, la meta es 88-92% para no anular el impulso respiratorio."},
    {q:"Masc 18a, Fx F√©mur Bilateral. P√°lido, TA 80/50.", o:["A. F√©rula tracci√≥n","B. Torniquete","C. Reposici√≥n Volumen","D. Analgesia"], a:2, e:"P√©rdida masiva de sangre interna (1-2L por f√©mur). Prioridad C."},
    {q:"Fem 28a, Asma. Sibilancias audibles, habla entrecortada.", o:["A. Salbutamol","B. Adrenalina","C. Ipratropio","D. Todas las anteriores"], a:0, e:"Broncodilatador beta-agonista es primera l√≠nea."},
    {q:"Masc 40a, Ca√≠da 3m. Ojos de Mapache y Battle.", o:["A. Fx LeFort","B. Fx Base de Cr√°neo","C. Fx Nasal","D. Fx Mand√≠bula"], a:1, e:"Signos tard√≠os de fractura de base de cr√°neo."},
    {q:"Fem 70a, Paro cardiaco presenciado. Ritmo en monitor: Ca√≥tico irregular sin QRS.", o:["A. Asistolia","B. Fibrilaci√≥n Ventricular","C. Taquicardia Ventricular","D. AESP"], a:1, e:"FV es ritmo desfibrilable prioritario."},
    {q:"Masc 35a, V√≥mito sangre fresca abundante y TA 90/60.", o:["A. Hemoptisis","B. Hematemesis","C. Melena","D. Rectorragia"], a:1, e:"Hematemesis = V√≥mito de sangre (Sangrado digestivo alto)."},
    {q:"Legal: Paciente competente niega atenci√≥n.", o:["A. Forzar traslado","B. Sedar y llevar","C. Alta en sitio (Consentimiento)","D. Llamar polic√≠a"], a:2, e:"Paciente aut√≥nomo tiene derecho a rechazar. Documentar bien."},
    {q:"Gineco: Prolapso de cord√≥n umbilical.", o:["A. Empujar cord√≥n","B. Introducir mano y elevar presentaci√≥n","C. Posici√≥n Trendelenburg","D. B y C"], a:3, e:"Descomprimir el cord√≥n manualmente es vital hasta ces√°rea."}
];
while(CASES.length < 100) CASES.push(CASES[Math.floor(Math.random()*CASES.length)]);

// --- LOGICA DEL SISTEMA ---
const app = {
    i: () => {
        // CARGA SEGURA CUANDO EL DOM EST√Å LISTO
        document.addEventListener('DOMContentLoaded', () => {
            app.cl();
            app.rg('calc-grid', Object.keys(TOOLS), app.tc);
            app.rg('farma-grid', FARMA, app.tf);
            app.rg('lex-grid', LEXICO, app.tl);
            sim.n();
        });
    },
    cl: () => {
        const d = new Date();
        const days = ['DOMINGO','LUNES','MARTES','MI√âRCOLES','JUEVES','VIERNES','S√ÅBADO'];
        const months = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
        document.getElementById('clock').innerText = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} | ${d.toLocaleTimeString()}`;
        requestAnimationFrame(app.cl);
    },
    nav: (i,b) => {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        document.getElementById('v-'+i).classList.add('active');
        document.querySelectorAll('.nav-b').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
    },
    tog: (i) => {
        const e = document.getElementById(i);
        e.style.display = e.style.display === 'none' ? 'block' : 'none';
    },
    filter: (v) => {
        const t = v.toLowerCase();
        document.querySelectorAll('details').forEach(d => {
            d.style.display = d.innerText.toLowerCase().includes(t) ? 'block' : 'none';
            if(t.length > 2) d.open = true;
        });
    },
    rg: (i,d,t) => { document.getElementById(i).innerHTML = d.map(t).join(''); },
    
    // TEMPLATE CALCULADORA (Grid 2 Cols)
    tc: (k) => `<div class="item" onclick="app.mo('${k}')"><span class="icon">üßÆ</span><h4>${k}</h4><span>${TOOLS[k].d}</span></div>`,
    
    // TEMPLATE FARMA (Lista)
    tf: (f) => `<div class="row"><h4>${f.n}</h4><div class="tags"><span class="tg tg-t">üéØ ${f.p}</span><span class="tg tg-a">üîÑ ${f.a}</span><span class="tg tg-r">‚õî ${f.c}</span></div><div style="font-size:0.75rem; margin-top:5px;">üíâ ${f.d}</div></div>`,
    
    // TEMPLATE LEXICO
    tl: (l) => `<div class="item"><h4>${l.t}</h4><span style="color:var(--sec)">"${l.c}"</span><p style="color:var(--dim); font-size:0.8rem; margin-top:5px;">${l.d}</p></div>`,
    
    // FILTROS
    renderFarma: (v) => { const q = (v||'').toLowerCase(); app.rg('farma-grid', FARMA.filter(x => x.n.toLowerCase().includes(q)), app.tf); },
    renderLex: (v) => { const q = (v||'').toLowerCase(); app.rg('lex-grid', LEXICO.filter(x => x.t.toLowerCase().includes(q)), app.tl); },
    
    // MODAL
    mo: (k) => {
        app.cc = TOOLS[k];
        document.getElementById('md-ti').innerText = k;
        document.getElementById('md-form').innerText = app.cc.fo; // F√≥rmula Visual
        document.getElementById('md-proc').innerText = app.cc.p;
        document.getElementById('md-check').innerText = app.cc.c;
        document.getElementById('md-in').innerHTML = app.cc.i.map(x => `<label style="display:block; font-size:0.8rem; color:var(--dim); margin-top:5px;">${x.l}</label><input id="${x.id}" class="inp">`).join('');
        document.getElementById('res').style.display = 'none';
        document.getElementById('modal').style.display = 'flex';
    },
    runC: () => {
        const v = app.cc.i.map(x => document.getElementById(x.id).value);
        if(v.some(x => x === "")) return alert("Faltan datos");
        document.getElementById('res').innerText = app.cc.r(app.cc.f(v));
        document.getElementById('res').style.display = 'block';
    },
    calcIMC: () => {
        const m = document.getElementById('imc-m').value, k = document.getElementById('imc-k').value;
        if(m && k) { let i = (k/(m*m)).toFixed(2); document.getElementById('imc-res').innerText = `IMC: ${i}`; }
    },
    pdf: () => {
        const d = new window.jspdf.jsPDF();
        d.text("TITANIUM REPORTE", 10, 10);
        d.text(new Date().toLocaleString(), 10, 20);
        d.save("Reporte.pdf");
    }
};

const sim = {
    s: 0,
    n: () => {
        const c = CASES[Math.floor(Math.random()*CASES.length)];
        document.getElementById('sim-q').innerText = c.q;
        document.getElementById('sim-opts').innerHTML = c.o.map((o,i) => `<button class="btn" style="background:#f8fafc; color:var(--text); text-align:left; border:1px solid #cbd5e1; font-weight:400;" onclick="sim.c(${i},${c.a},'${c.e}')">${o}</button>`).join('');
        document.getElementById('sim-fb').style.display = 'none';
    },
    c: (s,a,e) => {
        const f = document.getElementById('sim-fb');
        f.style.display = 'block';
        if(s === a) {
            sim.s++; f.style.background = '#dcfce7'; f.style.color = '#166534'; f.innerText = "‚úÖ CORRECTO: " + e;
        } else {
            sim.s = 0; f.style.background = '#fee2e2'; f.style.color = '#991b1b'; f.innerText = "‚ùå MAL: " + e;
        }
        document.getElementById('sim-score').innerText = sim.s;
        setTimeout(sim.n, 3500);
    }
};

const tts = {
    s: window.speechSynthesis,
    p: () => { tts.s.cancel(); const u = new SpeechSynthesisUtterance(document.querySelector('.view.active').innerText); u.lang='es-MX'; tts.s.speak(u); },
    pa: () => { if(tts.s.speaking) tts.s.pause(); },
    s: () => { tts.s.cancel(); }
};

app.i(); // INICIO SEGURO
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
const db = getDatabase(initializeApp({apiKey:"AIzaSyCa9NVc2xtc54SKLzSV01LP0htIwT56ndk", authDomain:"tum-titanium.firebaseapp.com", databaseURL:"https://tum-titanium-default-rtdb.firebaseio.com", projectId:"tum-titanium", storageBucket:"tum-titanium.firebasestorage.app", messagingSenderId:"404202558749", appId:"1:404202558749:web:61e5ae23cad27cacc7fdf4"}));
const PW = "MARIA0852";

window.db = {
    save: async(p,i) => { if(document.getElementById(i).value && prompt("üîë")===PW) { await push(ref(db,p),{texto:document.getElementById(i).value, fecha:new Date().toISOString()}); document.getElementById(i).value=""; alert("Guardado"); } },
    addLex: async() => { if(prompt("üîë")===PW) await push(ref(db,'lexico_personal'),{c:document.getElementById('lx-c').value, t:document.getElementById('lx-t').value, d:document.getElementById('lx-d').value}); },
    addFarma: async() => { if(prompt("üîë")===PW) await push(ref(db,'farma_personal'),{n:document.getElementById('fm-n').value, u:document.getElementById('fm-u').value, p:document.getElementById('fm-t').value, c:document.getElementById('fm-c').value, a:document.getElementById('fm-a').value, d:document.getElementById('fm-d').value}); },
    saveVitals: async() => { if(prompt("üîë")===PW) await push(ref(db,'historial_signos'),{fc:document.getElementById('sg-fc').value, tas:document.getElementById('sg-tas').value, sp:document.getElementById('sg-sp').value, date:new Date().toISOString()}); alert("Guardado"); }
};

// LISTENERS
['notas_estudio','notas_signos'].forEach(p => {
    onValue(ref(db,p), s => {
        const d = s.val(), k = p==='notas_estudio'?'out-est':'out-sig';
        const e = document.getElementById(k); e.innerHTML = "";
        if(d) Object.values(d).reverse().forEach(n => e.innerHTML += `<div class="note">${n.texto}</div>`);
    });
});
onValue(ref(db,'lexico_personal'), s => { if(s.val()) Object.values(s.val()).forEach(x => LEXICO.unshift(x)); app.renderLex(); });
onValue(ref(db,'farma_personal'), s => { if(s.val()) Object.values(s.val()).forEach(x => FARMA.unshift(x)); app.renderFarma(); });
</script>
</body>
</html>
